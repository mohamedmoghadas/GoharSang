
@{
    ViewBag.Title = "ویرایش ثبت ورودی";
    Layout = "~/Views/Shared/_layout.cshtml";
}

@model GoharSang.Models.vmModel.vmEditRecordEntry



<div class="container dailyCol">
    <div class="row dailyRow">
        <div class="col dailyLDiv">
            <a class="btn btn-primary dailyBtnTop" href="~/Home/Index" role="button">صفحه اصلی</a>
            <br>
            <div class="row">
                <div class="col-sm-12">
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>اسم معدن</label>
                            <select id="SelectMine" class="select2-placeholer form-control" data-placeholder="انتخاب">
                                <option value="@Model.re.IdMine">
                                    @Model.re.mine.Name
                                </option>
                                @foreach (var item in Model.listmine)
                                {
                                    if (Model.re.IdMine != item.Id)
                                    {

                                        <option value="@item.Id">@item.Name</option>
                                    }

                                }
                            </select>

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>نوع کوپ</label>
                            <select id="SelectCope" class="select2-placeholer form-control" data-placeholder="انتخاب">
                                <option value="@Model.re.IdCops">
                                    @Model.re.Cops.Name
                                </option>
                                @foreach (var item in Model.listCops)
                                {
                                    if (Model.re.IdCops!=item.Id)
                                    {

                                        <option value="@item.Id">@item.Name</option>
                                    }

                                    
                                }
                            </select>

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>وزن</label>
                            <input type="text" class="form-control txtLeft" id="weight" value="@Model.re.Weight">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>طول</label>
                            <input type="text" class="form-control txtLeft" id="lenght" value="@Model.re.length">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>عرض</label>
                            <input type="text" class="form-control txtLeft" id="width" value="@Model.re.width">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>ارتفاع</label>
                            <input type="text" class="form-control txtLeft" id="height" value="@Model.re.Height">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>کد کوپ</label>
                            <input type="text" class="form-control txtLeft" id="Copcode" value="@Model.re.CopsCod">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>انبار</label>
                            <select id="selectStore" class="select2-placeholer form-control" data-placeholder="انتخاب">
                                <option value="@Model.re.IdStore">
                                    @Model.re.Store.Name
                                </option>
                                @foreach (var item in Model.listStore)
                                {

                                    if (Model.re.IdStore != item.Id)
                                    {

                                        <option value="@item.Id">@item.Name</option>
                                    }


                                }
                            </select>

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>شماره ماشین</label>
                            <input type="text" id="Trucknumber" class="form-control txtLeft" value="@Model.re.Trucknumber">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>شماره حواله</label>
                            <input type="text" id="Transfernumber" class="form-control txtLeft" value="@Model.re.Transfernumber">

                        </div>
                    </div>

                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>شماره باسکول</label>
                            <input type="text" class="form-control txtLeft" id="basculenumber" value="@Model.re.basculenumber">

                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>تاریخ</label>
                            <input type="text" id="date"
                                   class="form-control jalali-datepicker" value="@clsPersianDate.MiladiToShamsi(Model.re.Date)">
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>ساعت</label>
                            <input id="time" class="form-control" value="@Model.re.Time">

                        </div>
                    </div>




                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>تصاویر</label>
                            <div class="col-sm-4 col-8" style="display:none">
                                <input type="file" id="file1" class="float-right" accept="image/*">
                                <input type="file" id="file2" class="float-right" accept="image/*">
                                <input type="file" id="file3" class="float-right" accept="image/*">
                                <input type="file" id="file4" class="float-right" accept="image/*">

                            </div>

                            <div class="row">
                                <div class="col-3">
                                    <button class="btn btn-primary fa fa-upload" onclick="file1.click()"></button>
                                </div>
                                <div class="col-3">
                                    <button class="btn btn-primary fa fa-upload" onclick="file2.click()"></button>
                                </div>
                                <div class="col-3">
                                    <button class="btn btn-primary fa fa-upload" onclick="file3.click()"></button>
                                </div>
                                <div class="col-3">
                                    <button class="btn btn-primary fa fa-upload" onclick="file4.click()"></button>
                                </div>
                            </div>
                            <label>نمایش</label>
                            <div class="row">
                                <div class="col-3">
                                    @if (Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).FirstOrDefault() != null)
                                    {

                                        <img id="img1" class="rounded entryImg" src="~/images/@Model.re.Record_the_Entrry_Image.Where(p=>p.IdRecordentry==Model.re.Id).FirstOrDefault().Image">
                                    }
                                    else
                                    {

                                        <img id="img1" class="rounded entryImg" />
                                    }
                                </div>
                                <div class="col-3">
                                    @if (Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).Skip(1).FirstOrDefault() != null)
                                    {
                                        <img id="img2" class="rounded entryImg" src="~/images/@Model.re.Record_the_Entrry_Image.Where(p=>p.IdRecordentry==Model.re.Id).Skip(1).FirstOrDefault().Image">

                                    }
                                    else
                                    {
                                        <img id="img2" class="rounded entryImg" />
                                    }
                                </div>
                                <div class="col-3">

                                    @if (Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).Skip(2).FirstOrDefault() != null)
                                    {
                                        <img id="img3" class="rounded entryImg" src="~/images/@Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).Skip(2).FirstOrDefault().Image">
                                    }
                                    else
                                    {
                                        <img id="img3" class="rounded entryImg" />
                                    }
                                </div>
                                <div class="col-3">
                                    @if (Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).Skip(3).FirstOrDefault() != null)
                                    {
                                        <img id="img4" class="rounded entryImg" src="~/images/@Model.re.Record_the_Entrry_Image.Where(p => p.IdRecordentry == Model.re.Id).Skip(3).FirstOrDefault().Image">
                                    }
                                    else
                                    {
                                        <img id="img4" class="rounded entryImg" />
                                    }
                                </div>


                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-primary float-left SaveBtn" onclick="BtnRecordEntry()" name="lenght">ذخیره</button>

                    </div>

                </div>
            </div>


        </div>
    </div>
</div>


@section localscript{

    <link href="~/js/Resource/css/plugins/select2/select2.css" rel="stylesheet">
    <link href="~/js/Resource/css/plugins/select3/select3.css" rel="stylesheet" />

    <script src="~/js/Resource/js/plugins/select2/select2.full.min.js"></script>
    <script src="~/js/Resource/js/plugins/select3/select3.full.min.js"></script>

    <script>
        var count = 0;

        $(document).keyup(function (event) {


            if (SelectMine.value != 0 &&
                SelectCope.value != 0 &&
                weight.value != "" &&
                lenght.value != "" &&
                width.value != "" &&
                height.value != "" &&
                Copcode.value != "" &&
                selectStore.value != 0 &&
                Trucknumber.value != "" &&
                Transfernumber.value != "" &&
                date.value != "" &&
                time.value != "" &&
                basculenumber.value != "") {
                if (event.keyCode == 13) {
                    if (count == 0) {
                        count = 1;
                        BtnRecordEntry();
                    }

                }
            }
        });
    </script>

    <script>
        $(document).ready(function () {


            $(".select2").select2();
            $(".select2-placeholer").select2({
                allowClear: true
            });


        });


    </script>




    <script>
        jsShowPic(file1, img1);
        jsShowPic(file2, img2);
        jsShowPic(file3, img3);
        jsShowPic(file4, img4);

    </script>


    <script>

        var StateRegister = false;


        function BtnRecordEntry() {

            if (SelectMine.value == 0 ||
                SelectCope.value == 0 ||
                weight.value == "" ||
                lenght.value == "" ||
                width.value == "" ||
                height.value == "" ||
                Copcode.value == "" ||
                selectStore.value == 0 ||
                Trucknumber.value == "" ||
                Transfernumber.value == "" ||
                date.value == "" ||
                time.value == "" ||
                basculenumber.value == "") {
                AlertInAjax("تمامی اطلاعات را وارد نمایید", modalAlertInAjax, "alert-danger");
                $(modalAlertInAjax).modal("show");

                return;
            }
            else {

                if (StateRegister == false) {

                    StateRegister = true;


                    var formdataRecordEntry = new FormData();

                    formdataRecordEntry.append('_re.Id', @Model.re.Id);

                    formdataRecordEntry.append('_re.IdMine', SelectMine.value);

                    formdataRecordEntry.append('_re.IdCops', SelectCope.value);

                    formdataRecordEntry.append('_re.Weight', weight.value);

                    formdataRecordEntry.append('_re.length', lenght.value);

                    formdataRecordEntry.append('_re.width', width.value);

                    formdataRecordEntry.append('_re.Height', height.value);

                    formdataRecordEntry.append('_re.CopsCod', Copcode.value);

                    formdataRecordEntry.append('_re.IdStore', selectStore.value);

                    formdataRecordEntry.append('_re.Transfernumber', Transfernumber.value);

                    formdataRecordEntry.append('_re.Trucknumber', Trucknumber.value);

                    formdataRecordEntry.append('_re.Time', time.value);

                    formdataRecordEntry.append('_re.basculenumber', basculenumber.value);

                    formdataRecordEntry.append('_Date', date.value);



                    formdataRecordEntry.append("_file", file1.files[0]);
                    formdataRecordEntry.append("_file", file2.files[0]);
                    formdataRecordEntry.append("_file", file3.files[0]);
                    formdataRecordEntry.append("_file", file4.files[0]);


                    $.ajax({
                        url: "/RecordEntry/RecordEntry",
                        type: "POST",
                        beforeSend: function () {
                            $(LoadingGift).show();

                        },
                        error: function (data) {
                                State = false;

                            $(LoadingGift).hide();

                            if (data.status == 513) {

                                AlertInAjax("کدکوپ تکراری است", modalAlertInAjax, "alert-danger");
                                $(modalAlertInAjax).modal('show');

                                return;
                            }

                            if (data.status == 532) {

                                AlertInAjax("سایز فایل درست انتخاب نشده", modalAlertInAjax, "alert-danger");
                                $(modalAlertInAjax).modal('show');

                                return;
                            }
                            if (data.status == 530) {

                                AlertInAjax("نوع فایل درست انتخاب نشده", modalAlertInAjax, "alert-danger");
                                $(modalAlertInAjax).modal('show');


                                return;

                            }

                        },
                        data: formdataRecordEntry,
                        enctype: 'multipart/form-data',
                        processData: false,
                        contentType: false,
                        success: function (data) {
                           count = 0;
                            StateRegister = false;

                            $(LoadingGift).hide();

                            AlertInAjax("عملیات با موفقیت انجام شد", modalAlertInAjax, "alert-success");
                            $(modalAlertInAjax).modal("show");
                            setInterval(function () { $(modalAlertInAjax).modal("hide"); }, 2000);
                            $(modalAlertInAjax).on("hidden.bs.modal", function () {

                                location.href = "/RecordEntry/Index";
                            });
                        }
                    });
                }


            }



        }
    </script>
}